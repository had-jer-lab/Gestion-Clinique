services:
  # Auth Service
  auth-service:
    build: ./Auth-Service
    container_name: auth-service
    ports:
      - "5009:5009"
    environment:
      - FLASK_APP=app.py
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5009
      - FLASK_DEBUG=False
      - USE_DOCKER=true
      - SECRET_KEY=${SECRET_KEY:-clinique2025}
      - DATABASE_URI=${DATABASE_URI:-sqlite:///instance/base.db}
    networks:
      - clinic-network
    volumes:
      - ./Auth-Service:/app
      - auth-data:/app/instance
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5009/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Doctors Service - Backend
  doctors-service:
    build: ./Doctors-Service/backend
    container_name: doctors-service
    ports:
      - "5000:5000"
    environment:
      - FLASK_APP=app.py
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - FLASK_DEBUG=False
      - USE_DOCKER=true
      - AUTH_URL=http://auth-service:5009
      - PATIENTS_URL=http://patients-backend:5001
      - RDV_URL=http://rdv-backend:5005
      - SECRET_KEY=${SECRET_KEY:-clinique2025}
    networks:
      - clinic-network
    depends_on:
      - auth-service
    volumes:
      - ./Doctors-Service/backend:/app
      - doctors-data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/doctors"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Doctors Service - Frontend
  doctors-frontend:
    build: ./Doctors-Service/frontend
    container_name: doctors-frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://doctors-service:5000/api
      - VITE_PATIENTS_URL=http://patients-backend:5001
      - VITE_RDV_URL=http://rdv-backend:5005
      - VITE_AUTH_URL=http://auth-service:5009
      - NODE_ENV=production
    networks:
      - clinic-network
    depends_on:
      - doctors-service
    volumes:
      - ./Doctors-Service/frontend:/app
      - /app/node_modules
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Patient Service - Backend
  patients-backend:
    build: ./Patient-Service/backend
    container_name: patients-backend
    ports:
      - "5001:5001"
    environment:
      - FLASK_APP=app.py
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5001
      - FLASK_DEBUG=False
      - USE_DOCKER=true
      - AUTH_URL=http://auth-service:5009
      - DOCTORS_URL=http://doctors-service:5000
      - RDV_URL=http://rdv-backend:5005
      - SECRET_KEY=${SECRET_KEY:-clinique2025}
      - DATABASE_URI=${DATABASE_URI:-sqlite:///clinique.db}
    networks:
      - clinic-network
    depends_on:
      - auth-service
      - doctors-service
    volumes:
      - ./Patient-Service/backend:/app
      - patient-uploads:/app/static/uploads
      - patient-data:/app/instance
    restart: unless-stopped

  # Patient Service - Frontend
  patients-frontend:
    build: ./Patient-Service/frontend
    container_name: patients-frontend
    ports:
      - "3001:3000"
    environment:
      - REACT_APP_API_URL=http://patients-backend:5001/api
      - NODE_ENV=production
    networks:
      - clinic-network
    depends_on:
      - patients-backend
    volumes:
      - ./Patient-Service/frontend:/app
      - /app/node_modules
    stdin_open: true
    tty: true
    restart: unless-stopped

  # RDV Service - Backend
  rdv-backend:
    build: ./RDV-Service/backend
    container_name: rdv-backend
    ports:
      - "5005:5005"
    environment:
      - FLASK_APP=app.py
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5005
      - FLASK_DEBUG=False
      - USE_DOCKER=true
      - AUTH_URL=http://auth-service:5009
      - PATIENTS_URL=http://patients-backend:5001
      - DOCTORS_URL=http://doctors-service:5000
      - SECRET_KEY=${SECRET_KEY:-clinique2025}
      - DATABASE_URI=${DATABASE_URI:-sqlite:///clinique.db}
    networks:
      - clinic-network
    depends_on:
      - auth-service
      - patients-backend
      - doctors-service
    volumes:
      - ./RDV-Service/backend:/app
      - rdv-data:/app/instance
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # RDV Service - Frontend
  rdv-frontend:
    build: ./RDV-Service/frontend
    container_name: rdv-frontend
    ports:
      - "3002:3000"
    environment:
      - REACT_APP_API_URL=http://rdv-backend:5005/api
      - NODE_ENV=production
    networks:
      - clinic-network
    depends_on:
      - rdv-backend
    volumes:
      - ./RDV-Service/frontend:/app
      - /app/node_modules
    stdin_open: true
    tty: true
    restart: unless-stopped

networks:
  clinic-network:
    driver: bridge
    name: clinic-network

volumes:
  patient-uploads:
  auth-data:
  doctors-data:
  patient-data:
  rdv-data: