<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Directeur - Clinique</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style> 
    body { font-family: 'Inter', sans-serif; }
    #sidebar { transition: transform 0.3s ease; }
  </style>
</head>
<body class="bg-gray-50">
 
<!-- BUTTON (always visible) -->
<button onclick="toggleSidebar()"
  class="fixed top-4 left-4 z-50 bg-blue-600 text-white p-2 px-3 rounded-lg shadow-md hover:bg-blue-700 transition">
  ‚ò∞
</button>

<!-- SIDEBAR -->
<div id="sidebar"
  class="fixed left-0 top-0 h-full w-56 bg-white shadow-xl p-5 transform -translate-x-full z-40">

  <!-- Profile utilisateur -->
  <div class="flex flex-col items-center mb-8 mt-16">
    <img src="https://th.bing.com/th/id/OIP.03v_p9o8qmfvTR03olZGswHaE_?w=230&h=180&c=7&r=0&o=7&cb=ucfimg2&dpr=1.3&pid=1.7&rm=3&ucfimg=1" 
         alt="Avatar" class="w-20 h-20 rounded-full mb-2 object-cover">
    <h3 class="text-lg font-bold text-gray-800">{{ user.nom }} {{ user.prenom }}</h3>
    <p class="text-sm text-gray-500">{{ user.role }}</p>
  </div>

  <ul class="space-y-3 text-base">
    <li><a href="/directeur/dashboard" class="block hover:text-blue-600 transition">üè† Tableau de bord</a></li>
    <li><a href="http://localhost:3001" class="block hover:text-blue-600 transition">üë• Patients</a></li>
    <li><a href="http://localhost:3002" class="block hover:text-blue-600 transition">üí∞ Factures</a></li>
    <li><a href="http://localhost:3000" class="block hover:text-blue-600 transition">üßë‚Äç‚öïÔ∏è M√©decins</a></li>
    <li><a href="/logout" class="block text-red-600 font-bold hover:underline transition">üö™ D√©connexion</a></li>
  </ul>
</div>

<div class="p-8 lg:p-12 max-w-7xl mx-auto">
  <h1 class="text-4xl font-bold text-gray-800 mb-2">Tableau de Bord du Directeur</h1>
  <p class="text-gray-600 mb-10">Vue d'ensemble des indicateurs cl√©s et des performances de la clinique.</p>
 
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition">
      <p class="text-gray-600">M√©decins Actifs</p>
      <p class="text-4xl font-bold text-blue-600" id="nb-medecins">0</p>
      <p class="text-sm text-green-600">Mise √† jour en temps r√©el</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition">
      <p class="text-gray-600">Secr√©taires</p>
      <p class="text-4xl font-bold text-purple-600" id="nb-secretaires">0</p>
      <p class="text-sm text-gray-500">Administrateurs actifs</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition">
      <p class="text-gray-600">Factures Pay√©es</p>
      <p class="text-4xl font-bold text-green-600" id="total-factures">0</p>
      <p class="text-sm text-green-600">Ann√©e en cours</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition">
      <p class="text-gray-600">Ordonnances Cr√©√©es</p>
      <p class="text-4xl font-bold text-orange-600" id="total-ordonnances">-</p>
    </div>
  </div>
 
  <!-- Revenu Global + Graphique -->
  <div class="bg-white p-8 rounded-xl shadow mb-10">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
      <h2 class="text-3xl font-bold text-gray-800">Revenu Global</h2>
      <button id="btn-historique" 
        class="mt-4 sm:mt-0 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium rounded-lg hover:from-blue-700 hover:to-blue-800 transition shadow-lg">
        Voir l'historique complet
      </button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-center">
      <div class="text-center lg:text-left">
        <p class="text-5xl lg:text-6xl font-extrabold text-gray-800" id="revenu-total">0 ‚Ç¨</p>
        <p class="text-xl text-green-600 mt-3 font-medium">Revenus de l'ann√©e en cours</p>
        <p class="text-lg text-gray-600 mt-6">
          <span id="total-factures2" class="font-bold text-2xl text-green-700">0</span> factures pay√©es
        </p>
      </div>
      <div class="w-full h-80 lg:h-96">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>
 
  <!-- Gestion des comptes administratifs -->
  <div class="bg-white p-8 rounded-xl shadow">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold">Gestion des comptes administratifs</h2>
      <button onclick="openAddModal()" 
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        + Ajouter un compte
      </button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-left" id="admin-table">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-4">R√¥le</th>
            <th class="px-6 py-4">Nom</th>
            <th class="px-6 py-4">Email</th>
            <th class="px-6 py-4">Mot de passe</th>
            <th class="px-6 py-4">Actions</th>
          </tr>
        </thead>
        <tbody id="admin-body">
          <tr><td colspan="5" class="text-center py-8 text-gray-500">Chargement...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
 
<!-- Modal ŸÑŸÑÿ•ÿ∂ÿßŸÅÿ© ŸàÿßŸÑÿ™ÿπÿØŸäŸÑ -->
<div id="adminModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 w-96">
    <h3 id="modalTitle" class="text-2xl font-bold mb-6">Ajouter un compte</h3>
    <input type="hidden" id="editId">
    <div class="space-y-4">
      <input type="text" id="nom" placeholder="Nom complet" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      <input type="email" id="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      <input type="password" id="password" placeholder="Mot de passe" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      <select id="role" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
        <option value="Directeur">Directeur</option>
        <option value="Secr√©taire">Secr√©taire</option>
      </select>
    </div>
    <div class="flex justify-end gap-3 mt-6">
      <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">Annuler</button>
      <button onclick="saveAdmin()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Enregistrer</button>
    </div>
  </div>
</div>
 
<script>
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  sidebar.classList.toggle("-translate-x-full");
}

async function loadAllData() {
  try {
    // Get doctors count
    const doctorsRes = await fetch('/api/doctors-count');
    const doctorsData = await doctorsRes.json();
    document.getElementById('nb-medecins').textContent = doctorsData.count;

    // Get admins
    const adminsRes = await fetch('/api/admins');
    const admins = await adminsRes.json();
    const tbody = document.getElementById('admin-body');
    tbody.innerHTML = '';
    
    admins.forEach(a => {
      tbody.innerHTML += `
        <tr class="border-b hover:bg-gray-50 transition">
          <td class="px-6 py-4">${a.role}</td>
          <td class="px-6 py-4 font-medium">${a.nom}</td>
          <td class="px-6 py-4">${a.email}</td>
          <td class="px-6 py-4">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
          <td class="px-6 py-4">
            <button onclick='editAdmin(${a.id}, \`${a.nom}\`, "${a.email}", "${a.password}", "${a.role}")' 
              class="text-blue-600 hover:underline mr-4">Modifier</button>
            <button onclick="deleteAdmin(${a.id})" 
              class="text-red-600 hover:underline">Supprimer</button>
          </td>
        </tr>`;
    });
    
    document.getElementById('nb-secretaires').textContent = 
      admins.filter(x => x.role === 'Secr√©taire').length;
  } catch (error) {
    console.error('Error loading data:', error);
    document.getElementById('admin-body').innerHTML = 
      '<tr><td colspan="5" class="text-center py-8 text-red-600">Erreur de chargement des donn√©es</td></tr>';
  }
}
 
function openAddModal() {
  document.getElementById('modalTitle').textContent = 'Ajouter un compte';
  document.getElementById('editId').value = '';
  document.getElementById('nom').value = '';
  document.getElementById('email').value = '';
  document.getElementById('password').value = '';
  document.getElementById('role').value = 'Secr√©taire';
  document.getElementById('adminModal').classList.remove('hidden');
}
 
function editAdmin(id, nom, email, password, role) {
  document.getElementById('modalTitle').textContent = 'Modifier le compte';
  document.getElementById('editId').value = id;
  document.getElementById('nom').value = nom;
  document.getElementById('email').value = email;
  document.getElementById('password').value = password;
  document.getElementById('role').value = role;
  document.getElementById('adminModal').classList.remove('hidden');
}
 
async function saveAdmin() {
  const id = document.getElementById('editId').value;
  const nom = document.getElementById('nom').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const role = document.getElementById('role').value;
 
  if (!nom || !email || !password) {
    alert("Tous les champs sont obligatoires");
    return;
  }
 
  const payload = { nom, email, password, role };
  if (id) payload.id = id;
 
  try {
    const url = id ? '/api/admins/update' : '/api/admins/add';
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
 
    if (data.success) {
      alert("‚úÖ Compte enregistr√© avec succ√®s !");
      closeModal();
      loadAllData();
    } else {
      alert("‚ùå Erreur: " + (data.error || "Probl√®me inconnu"));
    }
  } catch (err) {
    alert("‚ùå Erreur de connexion: " + err.message);
  }
}
 
async function deleteAdmin(id) {
  if (!confirm('Supprimer ce compte d√©finitivement ?')) return;
  
  try {
    await fetch(`/api/admins/delete/${id}`, { method: 'DELETE' });
    loadAllData();
  } catch (error) {
    alert("Erreur lors de la suppression");
  }
}
 
function closeModal() {
  document.getElementById('adminModal').classList.add('hidden');
}

// Load stats from RDV service
async function loadFactureStats() {
  try {
    const res = await fetch('/api/rdv/stats');
    const data = await res.json();
    
    document.getElementById("total-factures").textContent = data.total_factures || 0;
    document.getElementById("total-factures2").textContent = data.total_factures || 0;
    document.getElementById("revenu-total").textContent = 
      (data.revenu_total || 0).toLocaleString('fr-FR') + " ‚Ç¨";
 
    // Chart
    const ctx = document.getElementById("chart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin',
                 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'],
        datasets: [{
          label: `Revenu ${data.annee_courante || 2025}`,
          data: data.revenus_mensuels || [0,0,0,0,0,0,0,0,0,0,0,0],
          backgroundColor: "rgba(34,197,94,0.85)",
          borderColor: "#16a34a",
          borderWidth: 2,
          borderRadius: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  } catch (err) {
    console.error("Error loading stats:", err);
  }
}

// Historique button
document.getElementById("btn-historique").addEventListener("click", async () => {
  try {
    const res = await fetch('/api/rdv/stats/historique');
    const years = await res.json();
    
    let table = `<table class="min-w-full bg-white border rounded-lg shadow">
      <thead class="bg-blue-700 text-white">
        <tr>
          <th class="px-6 py-4">Ann√©e</th>
          <th class="px-6 py-4">Total (‚Ç¨)</th>
          <th>Jan</th><th>F√©v</th><th>Mar</th><th>Avr</th><th>Mai</th><th>Juin</th>
          <th>Juil</th><th>Ao√ª</th><th>Sep</th><th>Oct</th><th>Nov</th><th>D√©c</th>
        </tr>
      </thead><tbody>`;
    
    years.forEach(y => {
      table += `<tr class="border-b hover:bg-gray-50">
        <td class="px-6 py-4 font-bold">${y.annee}</td>
        <td class="px-6 py-4 text-green-600 font-bold">${y.total.toLocaleString('fr-FR')} ‚Ç¨</td>`;
      y.mensuel.forEach(m => {
        table += `<td class="px-3 py-2 text-right">${m ? m.toLocaleString('fr-FR') + ' ‚Ç¨' : '‚Äî'}</td>`;
      });
      table += `</tr>`;
    });
    
    table += `</tbody></table>`;
    
    const modal = document.createElement('div');
    modal.className = "fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50";
    modal.innerHTML = `
      <div class="bg-white rounded-xl max-w-5xl w-full overflow-auto max-h-screen">
        <div class="flex justify-between items-center px-6 py-4 border-b sticky top-0 bg-white">
          <h3 class="text-2xl font-bold">Historique des revenus</h3>
          <button class="text-3xl hover:text-gray-700">&times;</button>
        </div>
        <div class="p-6">${table}</div>
      </div>`;
    
    modal.querySelector("button").onclick = () => modal.remove();
    document.body.appendChild(modal);
  } catch (error) {
    alert("Erreur lors du chargement de l'historique");
  }
});
 
// Initialize on page load
document.addEventListener("DOMContentLoaded", () => {
  loadAllData();
  loadFactureStats();
});
</script>

</body>
</html>